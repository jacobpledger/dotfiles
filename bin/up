#!/bin/bash

function init_web() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose run --rm web bash -c "python src/manage.py test'
}

function init_web() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose exec web bash' Enter
	if $new && [ $position = '2' ]; then
		tmux send-keys -t $session:2 'make clean install' Enter
	fi
	tmux send-keys -t $session:$position Enter 'python src/manage.py '
}

function init_db() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose exec db bash' Enter 'sudo -u postgres psql -d ' ${1,,} Enter
}

function init_rabbit() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose exec rabbit bash' Enter
}

function init_worker() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose run --rm web bash -c "time celery worker -Q '
}

function init_es() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose exec els bash' Enter
}

function init_redis() {
	local session=$1
	local position=$2
	tmux send-keys -t $session:$position 'docker-compose exec redis bash' Enter
}

session=$1
new=$2
new=${new:=false}
directory=$HOME/Development/Projects/$session

web_test=1
web=2
db_pos=3
broker_pos=4
worker_pos=5

cd $directory
docker-compose up -d
tmux start-server
tmux new-session -c $directory -n 'bash' -s $session -A -d
tmux new-window -t $session -n 'web-test' -c $directory
tmux new-window -t $session -n 'web' -c $directory
tmux new-window -t $session -n 'db' -c $directory
tmux new-window -t $session -n 'broker' -c $directory
tmux new-window -t $session -n 'worker' -c $directory

init_web_test $session $web
init_web $session $web
init_db $session $db_pos
init_rabbit $session $broker_pos
init_worker $session $worker_pos $new

echo $session

if [ $session = "Vanessa" ]; then
	tmux new-window -t $session -n 'es' -c $directory
	init_es $session 6
	tmux new-window -t $session -n 'redis' -c $directory
	init_es $session 7
fi

tmux attach-session -t $session:0
